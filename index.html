<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Audio Transcriber</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            width: 100%;
            max-width: 28rem; /* Equivalent to md:max-w-md */
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: #4f46e5; /* Indigo 600 */
            color: #ffffff;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* Indigo 700 */
        }
        .btn-danger {
            background-color: #ef4444; /* Red 500 */
            color: #ffffff;
        }
        .btn-danger:hover {
            background-color: #dc2626; /* Red 600 */
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db; /* Gray 300 */
            font-size: 1rem;
        }
        .text-area {
            min-height: 8rem;
            background-color: #f9fafb; /* Gray 50 */
            border: 1px solid #e5e7eb; /* Gray 200 */
            padding: 1rem;
            border-radius: 0.5rem;
            font-size: 0.95rem;
            color: #374151; /* Gray 700 */
            white-space: pre-wrap; /* Preserve whitespace and breaks */
            word-wrap: break-word; /* Break long words */
        }
        .message-box {
            background-color: #fefcbf; /* Yellow 100 */
            border: 1px solid #fcd34d; /* Yellow 300 */
            color: #92400e; /* Yellow 800 */
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            text-align: center;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-2xl font-bold text-gray-800 text-center">Mobile Audio Transcriber</h1>

        <div class="flex flex-col gap-2">
            <label for="apiKeyInput" class="text-gray-700 font-medium">Gladia.io API Key:</label>
            <input type="password" id="apiKeyInput" class="input-field" placeholder="Enter your Gladia.io API key">
            <p class="text-sm text-gray-500">Your API key is used to access the Gladia.io speech-to-text service.</p>
        </div>

        <div class="flex gap-4 justify-center">
            <button id="startButton" class="btn btn-primary flex-1">Start Recording</button>
            <button id="stopButton" class="btn btn-danger flex-1" disabled>Stop Recording</button>
        </div>

        <div id="loadingIndicator" class="hidden message-box">
            <p>Processing audio, please wait...</p>
        </div>

        <div id="messageBox" class="hidden message-box"></div>

        <div class="flex flex-col gap-2">
            <label for="transcriptionOutput" class="text-gray-700 font-medium">Transcription:</label>
            <div id="transcriptionOutput" class="text-area">
                Your transcribed text will appear here.
            </div>
        </div>
        <div class="text-xs text-gray-400 text-right mt-4">v0.1.1</div>
    </div>

    <script>
        // Global variables for media recording
        let mediaRecorder;
        let audioChunks = [];
        let stream;
        let apiKey = ""; // This will be populated from the input field

        // DOM elements
        const apiKeyInput = document.getElementById('apiKeyInput');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const messageBox = document.getElementById('messageBox');
        const transcriptionOutput = document.getElementById('transcriptionOutput');

        // Function to show a message in the message box
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-100', 'border-red-300', 'text-red-800', 'bg-yellow-100', 'border-yellow-300', 'text-yellow-800');
            if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'border-red-300', 'text-red-800');
            } else {
                messageBox.classList.add('bg-yellow-100', 'border-yellow-300', 'text-yellow-800');
            }
            messageBox.classList.remove('hidden');
        }

        // Function to hide the message box
        function hideMessageBox() {
            messageBox.classList.add('hidden');
        }

        // Function to poll for transcription results
        async function pollForResult(resultUrl) {
            try {
                const response = await fetch(resultUrl, {
                    method: 'GET',
                    headers: {
                        'x-gladia-key': apiKey,
                    },
                });

                const result = await response.json();

                if (response.ok) {
                    if (result.status === 'done') {
                        transcriptionOutput.textContent = result.result.transcription.full_transcript;
                        showMessage("Transcription successful!", 'info');
                        loadingIndicator.classList.add('hidden');
                    } else if (result.status === 'processing' || result.status === 'queued') {
                        // Poll again after a delay
                        setTimeout(() => pollForResult(resultUrl), 5000);
                    } else {
                        throw new Error(`Transcription failed with status: ${result.status}`);
                    }
                } else {
                    throw new Error(`Failed to fetch transcription result: ${result.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error("Error polling for result:", error);
                transcriptionOutput.textContent = `Error: ${error.message}. Please try again.`;
                showMessage(`Error: ${error.message}. Failed to get transcription result.`, 'error');
                loadingIndicator.classList.add('hidden');
            }
        }

        // Function to upload audio and initiate transcription
        async function uploadAndTranscribe(audioBlob) {
            loadingIndicator.classList.remove('hidden');
            hideMessageBox();
            transcriptionOutput.textContent = 'Uploading audio...';

            apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                showMessage("Please enter your Gladia.io API key.", 'error');
                loadingIndicator.classList.add('hidden');
                transcriptionOutput.textContent = 'Your transcribed text will appear here.';
                return;
            }

            try {
                // Step 1: Upload the audio file
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm');

                const uploadResponse = await fetch("https://api.gladia.io/v2/upload", {
                    method: 'POST',
                    headers: {
                        'x-gladia-key': apiKey,
                    },
                    body: formData,
                });

                const uploadResult = await uploadResponse.json();

                if (!uploadResponse.ok) {
                    throw new Error(`Audio upload failed: ${uploadResult.detail || 'Unknown error'}`);
                }
                
                const audioUrl = uploadResult.audio_url;
                transcriptionOutput.textContent = 'Audio uploaded. Requesting transcription...';

                // Step 2: Request transcription with the audio URL
                const transcribePayload = {
                    audio_url: audioUrl,
                    language_behaviour: "automatic",
                };

                const transcribeResponse = await fetch("https://api.gladia.io/v2/pre-recorded", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-gladia-key': apiKey,
                    },
                    body: JSON.stringify(transcribePayload),
                });

                const transcribeResult = await transcribeResponse.json();

                if (!transcribeResponse.ok) {
                    throw new Error(`Transcription request failed: ${transcribeResult.detail || 'Unknown error'}`);
                }

                transcriptionOutput.textContent = 'Transcription in progress...';
                
                // Step 3: Poll for the result
                await pollForResult(transcribeResult.result_url);

            } catch (error) {
                console.error("Error during transcription process:", error);
                transcriptionOutput.textContent = `Error: ${error.message}. Please try again.`;
                showMessage(`Error: ${error.message}.`, 'error');
                loadingIndicator.classList.add('hidden');
            }
        }

        // Event listener for Start Recording button
        startButton.addEventListener('click', async () => {
            apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                showMessage("Please enter your Gladia.io API key before recording.", 'error');
                return;
            }

            try {
                // Request access to the user's microphone
                stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                // Ensure the MediaRecorder uses a supported MIME type for Gladia.io
                // Gladia.io supports various formats, webm is common and usually works well.
                const options = { mimeType: 'audio/webm' };
                mediaRecorder = new MediaRecorder(stream, options);
                audioChunks = []; // Clear previous chunks

                // Event handler for when audio data is available
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                // Event handler for when recording stops
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
                    
                    // Send the audio for transcription
                    await uploadAndTranscribe(audioBlob);

                    // Stop all tracks in the stream
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start(); // Start recording
                showMessage("Recording...", 'info');
                startButton.disabled = true;
                stopButton.disabled = false;
                transcriptionOutput.textContent = 'Recording started. Speak now...';
                hideMessageBox(); // Hide any previous error messages
            } catch (error) {
                console.error("Error accessing microphone:", error);
                showMessage(`Error accessing microphone: ${error.message}. Please ensure microphone permissions are granted.`, 'error');
                startButton.disabled = false;
                stopButton.disabled = true;
                transcriptionOutput.textContent = 'Your transcribed text will appear here.';
            }
        });

        // Event listener for Stop Recording button
        stopButton.addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop(); // Stop recording
                showMessage("Recording stopped. Processing audio...", 'info');
                startButton.disabled = false;
                stopButton.disabled = true;
            }
        });

        // Initialize button states on page load
        window.onload = () => {
            startButton.disabled = false;
            stopButton.disabled = true;
        };
    </script>
</body>
</html>
